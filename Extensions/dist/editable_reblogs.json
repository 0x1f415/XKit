{"id":"editable_reblogs","script":"//* TITLE Editable Reblogs **//\r\n//* VERSION 3.0.3 **//\r\n//* DESCRIPTION Restores ability to edit previous reblogs of a post **//\r\n//* DEVELOPER new-xkit **//\r\n//* FRAME false **//\r\n//* BETA false **//\r\n\r\nXKit.extensions.editable_reblogs = new Object({\r\n\r\n\trunning: false,\r\n\r\n\trun: function() {\r\n\t\tthis.running = true;\r\n\r\n\t\tXKit.interface.post_window_listener.add(\"editable_reblogs\", XKit.extensions.editable_reblogs.post_window);\r\n\t\tXKit.tools.add_css(\".control-reblog-tree {display: none; } .post-form--header .reblog-title {margin: 10px; color: #444} \"\r\n\t\t\t+ \".xkit-editable-reblogs-button { float: right; margin-left: 20px; }\"\r\n\t\t\t+ \".control.right.xkit-editable-reblogs-control { display: block; width: 210px; text-align: right }\", \"editable_reblogs_remove_content_tree\");\r\n\r\n\t\tvar pat_ver = XKit.tools.parse_version(XKit.installed.get(\"xkit_patches\").version);\r\n\t\tif (pat_ver.major <=5 && pat_ver.minor <= 3 && pat_ver.patch <= 0){\r\n\t\t\tXKit.extensions.xkit_updates.update('xkit_patches', function(result){\r\n\t\t\t\tif(result.errors){\r\n\t\t\t\t\tXKit.window.show('Updating error', 'ERROR: Editable Reblogs does not support your version of XKit Patches, '+\r\n\t\t\t\t\t'and cannot automatically update it.<br><br>'+\r\n\t\t\t\t\t\"Try force updating all extensions from the gallery, and if that fails, try uninstalling and reinstalling XKit.\",\r\n\t\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\twindow.location = window.location;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\t$('body').on('click', '#xkit-editable-reblogs-post', XKit.extensions.editable_reblogs.send_post_request);\r\n\t\t$('body').on('click', '#xkit-editable-reblogs-queue', XKit.extensions.editable_reblogs.send_queue_request);\r\n\t\t$('body').on('click', '#xkit-editable-reblogs-draft', XKit.extensions.editable_reblogs.send_draft_request);\r\n\t},\r\n\tpost_window: function() {\r\n\t\t//if we don't have a reblog tree to edit, gtfo\r\n\t\t//this also applies to new posts\r\n\t\t//which saves us from worrying about things like photo replies\r\n\t\tif ($(\".post-form .reblog-list\").length === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t//also just let chat, link, and quote posts do what they do\r\n\t\tvar post_type = XKit.interface.post_window.post_type();\r\n\t\tif (post_type.chat || post_type.quote) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t//set up new buttons\r\n\t\tXKit.extensions.editable_reblogs.add_button_controls();\r\n\t\tXKit.extensions.editable_reblogs.process_existing_content();\r\n\t},\r\n\tprocess_existing_content: function() {\r\n\t\tvar reblog_tree = $(\".post-form .reblog-list\");\r\n\r\n\t\tvar all_quotes = [];\r\n\t\tvar old_content = '';\r\n\t\tvar all_quotes_text = '';\r\n\t\t// Guard against double evaluation by marking the tree as processed\r\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\r\n\t\tif (reblog_tree.length > 0) {\r\n\t\t\tif (reblog_tree.hasClass(processed_class)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\treblog_tree.addClass(processed_class);\r\n\r\n\t\t\tvar title = reblog_tree.find('.reblog-title');\r\n\t\t\t$('.post-form--header').append(title);\r\n\t\t\treblog_tree.find(\".reblog-list-item\").each(function(index) {\r\n\t\t\t\tvar reblog_data = {\r\n\t\t\t\t\treblog_content: $(this).find('.reblog-content').html() ? $(this).find('.reblog-content').html() : '',\r\n\t\t\t\t\treblog_author: $(this).find('.reblog-tumblelog-name').text() ? $(this).find('.reblog-tumblelog-name').text() : '',\r\n\t\t\t\t\treblog_url: $(this).find('.reblog-tumblelog-name').attr('href') \r\n\t\t\t\t\t\t? $(this).find('.reblog-tumblelog-name').attr('href') \r\n\t\t\t\t\t\t: 'http://' + $(this).find('.reblog-tumblelog-name').text() + '.tumblr.com'\r\n\t\t\t\t};\r\n\t\t\t\tall_quotes.push(reblog_data);\r\n\t\t\t});\r\n\t\t\tall_quotes.forEach(function(data, index, all) {\r\n\t\t\t\tvar reblog_content = data.reblog_content.replace(\"tmblr-truncated read_more_container\", \"\");\r\n\t\t\t\tall_quotes_text = \"<p><a class='tumblr_blog' href='\" + data.reblog_url + \"'>\" + data.reblog_author + \"</a>:</p><blockquote>\" + all_quotes_text + reblog_content + \"</blockquote>\";\r\n\t\t\t});\r\n\t\t}\r\n\t\ttry {\r\n\t\t\told_content = XKit.interface.post_window.get_content_html();\r\n\t\t} catch (e) {\r\n\t\t\tXKit.tools.add_function(function() {\r\n\t\t\t\tTumblr.Events.trigger(\"postForms:saved\");\r\n\t\t\t}, true, \"\");\r\n\t\t\tXKit.window.show('Invalid editor type', 'ERROR: Editable Reblogs cannot currently get content from your default editor type. '+\r\n\t\t\t\t'To continue using editable reblogs, click <a target=\"_blank\" href=\"https://www.tumblr.com/settings/dashboard\">here</a> '+\r\n\t\t\t\t'to edit your dashboard settings to use the rich text editor or HTML editor',\r\n\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// add 'tumblr_blog' class to all tumblr.com links,\r\n\t\t// assuming that they're part of a reblog-structure that's not being parsed properly\r\n\t\tvar nodes = $(all_quotes_text + old_content);\r\n\t\tnodes.find('a[href*=\"tumblr.com\"]').addClass('tumblr_blog');\r\n\t\tvar nodes_text = $('<div>').append($(nodes).clone()).html();\r\n\t\tXKit.interface.post_window.set_content_html(nodes_text);\r\n\t\t//run submission cleanup before post is submitted\r\n\t\t$('.controls-container').on('click', '.create_post_button', XKit.extensions.editable_reblogs.process_submit);\r\n\r\n\t\t$(\".btn-remove-trail .icon\").click();\r\n\t\t$(\".control-reblog-trail\").hide();\r\n\t},\r\n\tadd_button_controls: function() {\r\n\t\tvar xkit_button = $('.post-form--save-button');\r\n\t\t$('.post-form--save-button').empty();\r\n\t\tvar new_button_content = \"<div class='control right xkit-editable-reblogs-control'>\"\r\n\t\t\t+ '<div class=\"post-form--save-button\" data-subview=\"savePostButton\">'\r\n\t\t\t+ '<button class=\"flat-button blue caption create_post_button xkit-editable-reblogs-button\" id=\"xkit-editable-reblogs-post\">Post</button>'\r\n\t\t\t+ '<button class=\"flat-button blue caption create_post_button xkit-editable-reblogs-button\" id=\"xkit-editable-reblogs-queue\">Queue</button>'\r\n\t\t\t+ '<button class=\"flat-button blue caption create_post_button xkit-editable-reblogs-button\" id=\"xkit-editable-reblogs-draft\">Draft</button>'\r\n\t\t\t+ '</div></div>';\r\n\t\t$('.post-form--controls .controls-container').append(new_button_content);\r\n\t},\r\n\tsend_post_request: function(e) {\r\n\t\te.preventDefault();\r\n\t\tvar request = XKit.extensions.editable_reblogs.build_svc_request();\r\n\t\trequest[\"post[state]\"] = \"0\";\r\n\t\tXKit.extensions.editable_reblogs.send_request(request);\r\n\t},\r\n\tsend_queue_request: function(e) {\r\n\t\te.preventDefault();\r\n\t\tvar request = XKit.extensions.editable_reblogs.build_svc_request();\r\n\t\trequest[\"post[state]\"] = \"2\";\r\n\t\tXKit.extensions.editable_reblogs.send_request(request);\r\n\t},\r\n\tsend_draft_request: function(e) {\r\n\t\te.preventDefault();\r\n\t\tvar request = XKit.extensions.editable_reblogs.build_svc_request();\r\n\t\trequest[\"post[state]\"] = \"1\";\r\n\t\tXKit.extensions.editable_reblogs.send_request(request);\r\n\t},\r\n\tbuild_svc_request: function() {\r\n\t\tvar post_type = XKit.interface.post_window.post_type();\r\n\t\tvar request = XKit.extensions.editable_reblogs.build_common_svc_request();\r\n\t\tif (post_type.text) {\r\n\t\t\trequest[\"post[type]\"] = \"regular\";\r\n\t\t\t//@TODO make title editable\r\n\t\t\trequest[\"post[one]\"] = $('.post-form--header .reblog-title').text();\r\n\t\t}\r\n\t\tif (post_type.photo) {\r\n\t\t\trequest[\"post[type]\"] = \"photo\";\r\n\t\t}\r\n\t\tif (post_type.video) {\r\n\t\t\trequest[\"post[type]\"] = \"video\";\r\n\t\t}\r\n\t\tif (post_type.note) {\r\n\t\t\trequest[\"post[type]\"] = \"note\";\r\n\t\t\trequest[\"post[three]\"] = request[\"post[two]\"];\r\n\t\t\trequest[\"post[two]\"] = \"\";\r\n\t\t}\r\n\t\tif (post_type.audio) {\r\n\t\t\trequest[\"post[type]\"] = \"audio\";\r\n\t\t}\r\n\t\tif (post_type.link) {\r\n\t\t\trequest[\"post[type]\"] = \"link\";\r\n\t\t\trequest[\"post[three]\"] = request[\"post[two]\"];\r\n\t\t\trequest[\"post[two]\"] = \"\";\r\n\t\t}\r\n\t\treturn request;\r\n\t},\r\n\tbuild_common_svc_request: function() {\r\n\t\tvar request = {};\r\n\t\tvar location_path = window.location.pathname;\r\n\t\tvar location_items = location_path.split(\"/\");\r\n\t\tlocation_items.shift();\r\n\t\trequest.form_key = XKit.interface.form_key();\r\n\t\trequest.channel_id = $('.post-form--header .tumblelog-select .caption').text();\r\n\t\trequest.detached = true; //?\r\n\t\trequest.reblog = location_items[0] === \"reblog\";\r\n\t\tif (location_items[0] === \"reblog\") {\r\n\t\t\trequest.reblog_id = parseInt(location_items[1]);\r\n\t\t}\r\n\t\tif (location_items[0] === \"edit\") {\r\n\t\t\trequest.post_id = parseInt(location_items[1]);\r\n\t\t}\r\n\t\trequest.reblog_key = location_items[2];\r\n\t\trequest.errors = false;\r\n\t\trequest.silent = false;\r\n\t\trequest.context_id = \"\";\r\n\t\tif (location_items[0] === \"reblog\") {\r\n\t\t\trequest.reblog_post_id = location_items[1];\r\n\t\t}\r\n\t\tif (location_items[0] === \"edit\") {\r\n\t\t\trequest.edit_post_id = location_items[1];\r\n\t\t}\r\n\t\trequest.remove_reblog_tree = true;\r\n\t\trequest[\"is_rich_text[one]\"] = \"0\";\r\n\t\trequest[\"is_rich_text[two]\"] = \"1\";\r\n\t\trequest[\"is_rich_text[three]\"] = \"0\";\r\n\t\trequest[\"post[slug]\"] = \"\";\r\n\t\trequest[\"post[draft_status]\"] = \"\";\r\n\t\trequest[\"post[date]\"] = \"\";\r\n\t\trequest[\"post[tags]\"] = $.map($('.post-form--footer .tag-label'), function(element, index) {\r\n\t\t\treturn $(element).text();\r\n\t\t}).join(\",\");\r\n\t\trequest[\"post[two]\"] = XKit.extensions.editable_reblogs.parse_html(XKit.interface.post_window.get_content_html());\r\n\t\tif ($('.post-forms--social-buttons .social-button.twitter').hasClass('checked')) {\r\n\t\t\trequest.send_to_twitter = \"on\";\r\n\t\t}\r\n\t\tif ($('.post-forms--social-buttons .social-button.facebook').hasClass('checked')) {\r\n\t\t\trequest.send_to_fbog = \"on\";\r\n\t\t}\r\n\t\t//@TODO maybe we can do this in the future\r\n\t\trequest.custom_tweet = false;\r\n\t\treturn request;\r\n\t},\r\n\tparse_html: function(data) {\r\n\t\t// tumblr_blog must be wrapped in single quotes, not double, or the dash will nom the shit out of your post\r\n\t\tvar text = XKit.interface.post_window.get_content_html();\r\n\t\t//********* DO ANY DOM MANIPULATION FIRST *************\r\n\t\t//******if done later it will undo the single quote fix*********\r\n\t\tvar nodes = $('<div>').append($(text));\r\n\t\tnodes.find('.tmblr-truncated').replaceWith('[[MORE]]');\r\n\t\ttext = nodes.html();\r\n\t\t//********ALL DOM MANIPULATION ABOVE THIS LINE*********\r\n\t\ttext = text.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\r\n\t\t// also remove empty HTML if the user hasn't added anything\r\n\t\tif (text.indexOf(\"<p><br></p>\", text.length - 11) !== -1) {\r\n\t\t\ttext = text.substring(0, text.length - 11);\r\n\t\t}\r\n\t\treturn text;\r\n\t},\r\n\tsend_request: function(request) {\r\n\t\tXKit.interface.kitty.get(function(kitty_data) {\r\n\r\n\t\t\tGM_xmlhttpRequest({\r\n\t\t\t\tmethod: \"POST\",\r\n\t\t\t\turl: \"http://www.tumblr.com/svc/post/update\",\r\n\t\t\t\tdata: JSON.stringify(request),\r\n\t\t\t\tjson: true,\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t\"X-tumblr-puppies\": kitty_data.kitten,\r\n\t\t\t\t\t\"X-tumblr-form-key\": XKit.interface.form_key(),\r\n\t\t\t\t},\r\n\t\t\t\tonerror: function(response) {\r\n\t\t\t\t\tXKit.interface.kitty.set(\"\");\r\n\t\t\t\t\tXKit.window.show(\"Error\",\r\n\t\t\t\t\t\t\"Error: XER-SR.<br /><br />There was an error reblogging your post. Please try again shortly. If you continue to receive this, please contact XKit staff.\",\r\n\t\t\t\t\t\t\"error\",\r\n\t\t\t\t\t\t\"<div class=\\\"xkit-button default\\\" id=\\\"xkit-close-message\\\">OK</div><a href=\\\"http://new-xkit-extension.tumblr.com/\\\" class=\\\"xkit-button\\\">Visit the New XKit Blog</a>\");\r\n\t\t\t\t},\r\n\t\t\t\tonload: function(response) {\r\n\t\t\t\t\t// We are done!\r\n\t\t\t\t\tXKit.interface.kitty.set(response.getResponseHeader(\"X-tumblr-kittens\"));\r\n\t\t\t\t\tXKit.tools.add_function(function() {\r\n\t\t\t\t\t\tTumblr.Events.trigger(\"postForms:saved\");\r\n\t\t\t\t\t}, true, \"\");\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\t},\r\n\tdestroy: function() {\r\n\t\tthis.running = false;\r\n\t\tXKit.tools.remove_css(\"editable_reblogs_remove_content_tree\");\r\n\t\t$('body').off('click', '#xkit-editable-reblogs-post', XKit.extensions.editable_reblogs.send_post_request);\r\n\t\t$('body').off('click', '#xkit-editable-reblogs-queue', XKit.extensions.editable_reblogs.send_queue_request);\r\n\t\t$('body').off('click', '#xkit-editable-reblogs-draft', XKit.extensions.editable_reblogs.send_draft_request);\r\n\t\tXKit.interface.post_window_listener.remove(\"editable_reblogs\");\r\n\t}\r\n});\r\n","file":"found","server":"up","errors":false,"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAA4VBMVEUAAAAAAQEBAgICBAQCBQYDBggEBwkHDRAHDhIIEBQIEBUJEhYKFhALFRoLFRsMGRUNGSAPIRgQHycYLzsYNScbNkMcNkQcN0UdOEYdOEceOkgfPUwfPU0gPk0gPk4gP08hQFAiQlMjTTgjTTkkTjktV20tWG4yYXoyYns4bIg7co9Bfp9Bj2lEhKZFhqdFh6lFh6pHiq1JjrJJj7NMlLpNlbtNlrtNlrxNl7pNl7tNmLpOmLlQpKpQpalRpqZRpqdRp6VSqaNSsoNTr5tTsJpTsZhTsZlUspdUsphWu4lWvIqrAtY3AAABFklEQVR42qXQa1OCQBiG4cdKOtn5bEmaZklaZi5v27kgi/3/PygY9l1g02Gm7m/wXMPsAippCpBlYCJLgGIxE6hPWQTfyooFA/W7txIQ+DZ4pCzeC4DyIJRkg/c80Ltodg14sf/ka7yfotLV4Inonmi0Pw9ua0DjPaBynoJ4/yI6gGn3Q7R6iWhoICeKqIqhuUbkLjmxaIgU+KGKAaD3BxV1Vr2Vhd5YpGfwA5UEKF3UrnnrQIuv+awYmL0f78n3p34hOqv1N3jXZwjyZ3AXvTXAFdcZIBlm4AZzy8l+u8kgFQZcAMlO22CQCgOOATQFPxpA5s3OyeWQaAbg/giqGOT2Kzg2qKNY3QajQwdZztEdg5L+D34AmZvHFbsM2NwAAAAASUVORK5CYII=\r\n","title":"Editable Reblogs","description":"Restores ability to edit previous reblogs of a post","developer":"new-xkit","version":"3.0.3","frame":"false","beta":"false","slow":"false"}